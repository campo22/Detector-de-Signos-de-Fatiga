<!-- Chatbot Toggle Button -->
<div class="fixed bottom-6 right-6 z-40 group animate-fade-in">
  <button (click)="toggleChat()" 
     class="w-16 h-16 flex items-center justify-center bg-landing-primary rounded-full shadow-lg shadow-primary-glow hover:bg-landing-primary-focus transition-all duration-300 ease-in-out transform hover:scale-110">
    @if (!isOpen()) {
      <span class="material-symbols-outlined text-3xl text-white">voice_chat</span>
    } @else {
      <span class="material-symbols-outlined text-3xl text-white">close</span>
    }
  </button>
  <div class="absolute right-full mr-4 top-1/2 -translate-y-1/2 px-4 py-2 bg-[#111620] text-text-dark-primary rounded-lg shadow-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
    {{ 'chatbot.tooltip' | translate }}
    <div class="absolute left-full top-1/2 -translate-y-1/2 w-2 h-2 bg-[#111620] rotate-45"></div>
  </div>

  <!-- Proactive message bubble -->
  @if (showProactiveMessage()) {
    <div class="absolute right-full mr-4 bottom-0 mb-2 px-4 py-2 bg-landing-primary text-white rounded-lg shadow-lg whitespace-nowrap animate-fade-in-scale pointer-events-none">
      {{ 'chatbot.proactive' | translate }}
      <div class="absolute left-full top-1/2 -translate-y-1/2 w-2 h-2 bg-landing-primary rotate-45"></div>
    </div>
  }
</div>

<!-- Chatbot Window -->
@if (isOpen()) {
  <div class="fixed bottom-24 right-6 z-40 w-full max-w-sm h-[60vh] flex flex-col bg-[#111620] rounded-xl border border-border-dark shadow-2xl animate-fade-in-scale">
    <!-- Header -->
    <div class="flex-shrink-0 flex items-center justify-between p-4 border-b border-border-dark">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 text-landing-primary">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z" stroke="currentColor" stroke-width="1.5"/>
            <path d="M13.5 16L10.5 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h3 class="font-bold text-text-dark-primary">{{ 'chatbot.tooltip' | translate }}</h3>
      </div>
    </div>

    <!-- Messages -->
    <div #messageContainer class="flex-grow p-4 overflow-y-auto space-y-4 scroll-smooth">
      @for (message of messages(); track $index) {
        <div class="flex" [class.justify-end]="message.from === 'user'">
          <div class="max-w-xs md:max-w-md px-4 py-2 rounded-lg" 
              [class.bg-landing-primary]="message.from === 'user'"
              [class.text-white]="message.from === 'user'"
              [class.bg-[#0D1117]]="message.from === 'bot'"
              [class.text-landing-text-dark-secondary]="message.from === 'bot'">
            <p class="text-sm break-words">{{ message.text }}</p>
          </div>
        </div>
      }
      @if (isLoading()) {
        <div class="flex justify-start">
          <div class="max-w-xs px-4 py-2 rounded-lg bg-[#0D1117] text-landing-text-dark-secondary">
             <div class="flex items-center gap-2 text-sm text-landing-text-dark-secondary">
                <div class="w-1.5 h-1.5 bg-landing-primary rounded-full animate-pulse"></div>
                <div class="w-1.5 h-1.5 bg-landing-primary rounded-full animate-pulse [animation-delay:0.2s]"></div>
                <div class="w-1.5 h-1.5 bg-landing-primary rounded-full animate-pulse [animation-delay:0.4s]"></div>
                <span class="ml-1">{{ 'chatbot.typing' | translate }}</span>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Quick Replies -->
    @if (quickReplies().length > 0) {
      <div class="flex-shrink-0 px-4 pb-2 flex justify-start gap-2 flex-wrap animate-fade-in border-t border-border-dark pt-4">
        @for (reply of quickReplies(); track reply.payload) {
          <button (click)="sendQuickReply(reply.payload, reply.text)"
            class="px-3 py-1.5 text-sm text-landing-primary bg-landing-primary/10 border border-landing-primary/20 rounded-full hover:bg-landing-primary/20 transition-colors">
            {{ reply.text }}
          </button>
        }
      </div>
    }

    <!-- Input Form -->
    <div class="flex-shrink-0 p-4" [class.border-t]="quickReplies().length === 0" [class.border-border-dark]="quickReplies().length === 0">
      <form [formGroup]="chatForm" (ngSubmit)="sendMessage()" class="flex items-center gap-2">
        <input formControlName="message" type="text" placeholder="Escribe tu pregunta..." autocomplete="off"
               class="w-full rounded-full border-border-dark bg-[#0D1117] focus:ring-2 focus:ring-landing-primary/50 focus:border-landing-primary text-text-dark-primary placeholder-gray-500 transition-colors">
        <button type="submit" [disabled]="chatForm.invalid || isLoading()" 
                class="w-10 h-10 flex-shrink-0 flex items-center justify-center bg-landing-primary rounded-full text-white hover:bg-landing-primary-focus transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          <span class="material-symbols-outlined text-xl">send</span>
        </button>
      </form>
    </div>
  </div>
}
